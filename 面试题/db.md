# 关于db的一些面试题

[TOC]



## mysql



## redis

### redis缓存雪崩、击穿、穿透

#### 雪崩

 缓存雪崩是指，缓存层出现了错误，不能正常工作了。于是所有的请求都会达到存储层，存储层的调用量会暴增，造成存储层也会挂掉的情况。

##### 解决方案

（1）redis高可用

这个思想的含义是，既然redis有可能挂掉，那我多增设几台redis，这样一台挂掉之后其他的还可以继续工作，其实就是搭建的集群。

（2）限流降级

这个解决方案的思想是，在缓存失效后，通过加锁或者队列来控制读数据库写缓存的线程数量。比如对某个key只允许一个线程查询数据和写缓存，其他线程等待。

（3）数据预热

数据加热的含义就是在正式部署之前，我先把可能的数据先预先访问一遍，这样部分可能大量访问的数据就会加载到缓存中。在即将发生大并发访问前手动触发加载缓存不同的key，设置不同的过期时间，让缓存失效的时间点尽量均匀。

#### 缓存穿透

缓存穿透的概念很简单，用户想要查询一个数据，发现redis内存数据库没有，也就是缓存没有命中，于是向持久层数据库查询。发现也没有，于是本次查询失败。当用户很多的时候，缓存都没有命中，于是都去请求了持久层数据库。这会给持久层数据库造成很大的压力，这时候就相当于出现了缓存穿透。

这里需要注意和缓存击穿的区别，缓存击穿，是指一个key非常热点，在不停的扛着大并发，大并发集中对这一个点进行访问，当这个key在失效的瞬间，持续的大并发就穿破缓存，直接请求数据库，就像在一个屏障上凿开了一个洞。

##### 解决方案

* 布隆过滤器
* 缓存空对象，当存储层不命中后，即使返回的空对象也将其缓存起来，同时会设置一个过期时间，之后再访问这个数据将会从缓存中获取，保护了后端数据源；

### redis缓存策略

#### Cache-aside(lazy-loading 延迟加载)

基本的数据获取的逻辑总结如下:

1. 当应用程序需要从数据库读取数据时，先检查缓存确定数据是否可用
2. 若数据在缓存中(cache hit),返回缓存中的数据
3. 若数据不在缓存中(cache miss)，则从数据库读取数据，然后将读取到的数据放入缓存中。最后将数据返回给应用程序

##### 优势

* 缓存只包含应用程序需要的数据，使得缓存大小更高效
* 实现简单

##### 劣势

缓存未命中时，比较慢

#### Write-Back(Write-behind) 回写

数据先写入缓存，然后异步的将数据更新到数据存储

#### Write-Through(透写)

基本的数据获取逻辑如下：

1. 应用程序或其他后端进程先更新数据库
2. 然后，数据更新到缓存

##### 优势

* 缓存和数据库保持同步，缓存命中的概率更大，反过来会提升应用性能和用户体验
* 减少数据库读取

##### 劣势

不被经常使用的数据也会写入到缓存，导致缓存更大



#### 总结

延迟加载和透写一般一起使用



### 缓存淘汰机制 (Evictions )

 least frequently used: 最少频繁使用，应该是访问次数最少即访问不频繁，访问次数少的优先淘汰？

 least recently used: 最近最少使用。应该是以key的最后的访问时间为标准么,最久未访问的优先淘汰？

| 淘汰机制        | 描述                             |
| --------------- | -------------------------------- |
| allkeys-lru     | 淘汰最久未访问的key              |
| allkeys-lfu     | 淘汰访问次数最少的key            |
| volatile-lru    | 淘汰设置了TTL的最久未访问的key   |
| volatile-lfu    | 淘汰设置了TTL的访问次数最少的key |
| volatile-ttl    | 淘汰TTL最小的key                 |
| volatile-random | 随机淘汰一个设置了TTL的key       |
| allkeys-random  | 随机淘汰一个key                  |
| no-eviction     | 不淘汰                           |



## 参考

### redis

* 雪崩、穿透、击穿 <https://baijiahao.baidu.com/s?id=1655304940308056733&wfr=spider&for=pc>
* 缓存策略 https://d0.awsstatic.com/whitepapers/Database/database-caching-strategies-using-redis.pdf
