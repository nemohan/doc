# 磁盘

[TOC]



### 传统机械式磁盘的延迟



### 磁盘IO模型





### 磁盘故障

常见的磁盘故障：

* 间断性故障，读或写一个扇区的某次尝试没有成功，但是经过反复尝试又能成功读写

* 一个或多个二进制位永久损坏(坏块或介质损坏)。导致某个扇区无法读取
* 写故障,企图写一个扇区时，既不能正确的写，也不能正确的读
* 磁盘崩溃，在这种故障中，整个磁盘突然变为永久不可读

#### 处理间断性故障—奇偶校验和

使用奇偶校验和的目的就是校验写入磁盘块的数据是否发生了改变，若发生了改变，可以多次尝试读取来避免间断性故障

原理：

<font color="red">一种简单形式是根据扇区内的`所有二进制位的奇偶性`。若在二进制集合中有奇数个1，就说此数据具有`奇数奇偶性`。并且再增加一个为1的奇偶位；若二进制集合中有偶数个1，就说次数据具有`偶数奇偶性`,则再增加一个值为0的二进制位。从而:</font>

* 二进制位的集合和他们的奇偶位中，1的个数总是偶数。
* 若**任意一位**发生改变，则1的个数就变为奇数。因此读取数据时可以根据1的个数确定数据是否发生了改变。

具体实现就是在写扇区时，计算数据的奇偶性， 在附加上奇偶位即可。

如扇区中的二进制位是01101000, 就有奇数个1。所以奇偶位就是1。在这个二进制序列上加上奇偶位就得到011010001。若扇区中的二进制位是11101110, 有偶数个1。所以奇偶位是0。加上奇偶位得到111011100

##### 只使用1位奇偶位的缺陷：

<font color="green">可能出现多个二进制位出错，这种情况下，二进制为1的个数为偶数的可能性是50%（至于为啥是50%，总的二进制位的个数是奇数n，其中偶数约占一半n /2), 而且检测不到错误</font>

可以使用多个奇偶位，比如8位奇偶校验位。第一位用于检测每个字节的第一位，第二位检测每个字节的第二位，以此类推。这样，任意一个奇偶位检测出错误的可能性是50%。8位都检测不出错误的可能性是1/2^8(2的8次方分之一。至于为啥是1/2^8,这得参考伯努利概率模型了，每个校验位都是独立的，且检测出错误的可能性是50%。8个校验位就是 1/2 * 1/2 * 1/2 ... 1/2)

书上说可以使用4子节作为奇偶校验位，将出错但不能检测出的概率降到1/40亿分之一。比较想知道该怎么使用.

一种可能的用法:

一个扇区n字节, m=n/32。即每个校验位负责m个字节



#### 稳定存储—纠正错误

#### RAID1 磁盘镜像

#### RAID4 

#### RAID5

#### RAID6

### 参考

* 《数据库系统实现》或《database system: the complete book》

